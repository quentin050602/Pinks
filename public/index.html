<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>Fort Lauderdale Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <style>
    #map { height: 100vh; width: 100%; }
    .search-container {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: white;
      padding: 5px;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="search-container">
    <input id="searchBox" type="text" placeholder="Adresse suchen..." />
    <button onclick="searchAddress()">üîç</button>
  </div>


  <script>
    const BACKEND_URL = "https://pinks.onrender.com";

    var map = L.map('map').setView([26.1224, -80.1373], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(map);

    var drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    var drawControl = new L.Control.Draw({
      edit: { featureGroup: drawnItems },
      draw: { polygon: true, polyline: true, marker: true, rectangle: true, circle: false }
    });
    map.addControl(drawControl);

    var icons = {
      "ja": L.icon({ iconUrl: "icons/green.png", iconSize: [30, 30] }),
      "nein": L.icon({ iconUrl: "icons/red.png", iconSize: [30, 30] }),
      "vielleicht": L.icon({ iconUrl: "icons/yellow.png", iconSize: [30, 30] }),
      "default": L.icon({ iconUrl: "icons/default.png", iconSize: [30, 30] })
    };

    map.on(L.Draw.Event.CREATED, function (event) {
      var layer = event.layer;
      drawnItems.addLayer(layer);

      if (layer instanceof L.Marker) {
        getAddress(layer.getLatLng(), function(address) {
          showHousePopup(layer, address, layer);
        });
      } else {
        chooseColor(layer);
      }
    });

    function getAddress(latlng, callback) {
      fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latlng.lat}&lon=${latlng.lng}`)
        .then(response => response.json())
        .then(data => callback(data.display_name || "Unbekannte Adresse"))
        .catch(() => callback("Adresse nicht gefunden"));
    }

      function showHousePopup(layer, address) {
          let popupContent = `
              <p><strong>Adresse:</strong> ${address}</p>
              <label>Familienname:</label>
              <input type="text" id="familyName" placeholder="Nachname eingeben" />
              <p>Hat dieser Haushalt Interesse?</p>
              <button onclick="setInterest('${address}', ${layer._leaflet_id || 'null'}, 'ja')">Ja</button>
              <button onclick="setInterest('${address}', ${layer._leaflet_id || 'null'}, 'nein')">Nein</button>
              <button onclick="setInterest('${address}', ${layer._leaflet_id || 'null'}, 'vielleicht')">Vielleicht</button>
          `;

          layer.bindPopup(popupContent).openPopup();

          // ‚úÖ Direkte Speicherung mit "vielleicht" als Standard
          setInterest(address, layer._leaflet_id || 'null', 'vielleicht');
      }


      function setInterest(address, layerId, interest) {
          var familyName = document.getElementById("familyName") ? document.getElementById("familyName").value : "Unbekannt";
          var layer = drawnItems.getLayer(layerId) || searchMarker; // üî• Falls `layerId` nicht existiert, `searchMarker` nehmen

          if (!layer) {
              console.error("‚ùå Kein g√ºltiger Marker gefunden.");
              return;
          }

          layer.setIcon(icons[interest]); // ‚úÖ Icon setzen

          fetch(`${BACKEND_URL}/save-house`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                  lat: layer.getLatLng().lat,
                  lon: layer.getLatLng().lng,
                  interest,
                  address,
                  familyName
              })
          }).then(() => {
              console.log("‚úÖ Haus gespeichert:", address);
              loadHouses(); // üî• Damit die √Ñnderungen sofort sichtbar sind.
          }).catch(error => console.error("‚ùå Fehler beim Speichern:", error));
      }


    function loadHouses() {
      fetch(`${BACKEND_URL}/get-houses`)
        .then(response => response.json())
        .then(data => {
          drawnItems.clearLayers();
          data.forEach(house => {
            var marker = L.marker([house.lat, house.lon], { icon: icons[house.interest || "default"] })
              .bindPopup(`
                <p><strong>Familie ${house.family_name || "Unbekannt"}</strong></p>
                <p>${house.full_address || "Adresse nicht gefunden"}</p>
                <p>Interesse: ${house.interest || "Unbekannt"}</p>
                <button onclick="deleteHouse(${house.lat}, ${house.lon})">L√∂schen</button>
              `);
            drawnItems.addLayer(marker);
          });
        });
    }

      function saveDrawings() {
          let geoJsonData = drawnItems.toGeoJSON(); // GeoJSON der Zeichnungen abrufen

          fetch(`${BACKEND_URL}/save-drawings`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(geoJsonData) // Direkt speichern
          })
          .then(response => response.json())
          .then(data => {
              if (data.success) {
                  console.log("‚úÖ Zeichnungen erfolgreich gespeichert!");
              } else {
                  console.error("‚ùå Fehler beim Speichern der Zeichnungen:", data.error);
              }
          })
          .catch(error => console.error("‚ùå Netzwerkfehler beim Speichern der Zeichnungen:", error));
      }


      
      function saveDrawings() {
          let geoJsonData = drawnItems.toGeoJSON(); // GeoJSON der Zeichnungen abrufen

          fetch(`${BACKEND_URL}/save-drawings`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(geoJsonData) // Direkt speichern
          })
          .then(response => response.json())
          .then(data => {
              if (data.success) {
                  console.log("‚úÖ Zeichnungen erfolgreich gespeichert!");
              } else {
                  console.error("‚ùå Fehler beim Speichern der Zeichnungen:", data.error);
              }
          })
          .catch(error => console.error("‚ùå Netzwerkfehler beim Speichern der Zeichnungen:", error));
      }

      

      // üîç **Auto-Suggest f√ºr Adresssuche**
      document.getElementById("searchBox").addEventListener("input", function () {
        let query = this.value.trim();
        if (query.length < 3) return;

        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}`)
          .then(response => response.json())
          .then(data => {
            let suggestionsList = document.getElementById("suggestions");
            suggestionsList.innerHTML = "";

            data.forEach(item => {
              let option = document.createElement("option");
              option.value = item.display_name;
              suggestionsList.appendChild(option);
            });
          })
          .catch(error => console.error("Fehler beim Abrufen der Vorschl√§ge:", error));
      });

      // üîç **Suche mit Button oder Enter-Taste**
      let searchMarker = null;
      function searchAddress() {
          let query = document.getElementById("searchBox").value.trim();
          if (query === "") {
              alert("‚ùå Bitte eine Adresse eingeben!");
              return;
          }

          fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}`)
              .then(response => response.json())
              .then(data => {
                  console.log("üì° API Antwort:", data);

                  if (data.length === 0) {
                      alert("‚ùå Adresse nicht gefunden!");
                      return;
                  }

                  let latlng = {
                      lat: parseFloat(data[0].lat),
                      lng: parseFloat(data[0].lon)
                  };

                  // Falls bereits ein Marker existiert, entfernen
                  if (searchMarker) {
                      map.removeLayer(searchMarker);
                  }

                  // Setze neuen Marker
                  searchMarker = L.marker(latlng, { icon: icons["default"] }).addTo(map);

                  // Ansicht auf neue Position setzen
                  map.setView(latlng, 16);

                  // Adresse abrufen und Eingabeformular anzeigen
                  getAddress(latlng, function(address) {
                      showHousePopup(searchMarker, address);
                  });
              })
              .catch(error => console.error("‚ùå Fehler bei der Adresssuche:", error));
      }


      document.getElementById("searchBox").addEventListener("change", function () {
        searchAddress();
      });

    loadDrawings();
    loadHouses();
  </script>
</body>
</html>









