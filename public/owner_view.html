<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>Fort Lauderdale Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <style>
    #map { height: 100vh; width: 100%; }
    .search-container {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: white;
      padding: 5px;
      border-radius: 5px;
    }
      /* Dropdown-Button */
      .dropbtn {
          background-color: #4CAF50;
          color: white;
          padding: 10px 15px;
          font-size: 16px;
          border: none;
          cursor: pointer;
          position: absolute;
          top: 10px;
          left: 10px;
          border-radius: 5px;
      }

      /* Dropdown-Container */
      .dropdown {
          position: absolute;
          top: 10px;
          left: 10px;
          display: inline-block;
      }

      /* Dropdown-Inhalt */
      .dropdown-content {
          display: none;
          position: absolute;
          background-color: white;
          min-width: 200px;
          box-shadow: 0px 8px 16px rgba(0,0,0,0.2);
          z-index: 1000;
          border-radius: 5px;
      }

      /* Links im Dropdown */
      .dropdown-content a {
          color: black;
          padding: 10px;
          text-decoration: none;
          display: block;
      }

      /* Hover-Effekt */
      .dropdown-content a:hover {
          background-color: #f1f1f1;
      }

      /* Zeige das Men√º, wenn der Button angeklickt wird */
      .dropdown:hover .dropdown-content {
          display: block;
      }

  </style>
</head>
<body>
    <div class="dropdown">
        <button class="dropbtn">‚öôÔ∏è Men√º</button>
        <div class="dropdown-content">
            <a href="#" onclick="toggleDrawingTools()">‚úèÔ∏è Werkzeuge anzeigen/verbergen</a>
            <a href="register.html">üë§ Benutzer registrieren</a>
            <a href="#" onclick="logout()">üö™ Logout</a>
        </div>
    </div>

    <h2>Neuen Benutzer hinzuf√ºgen</h2>
    <div style="padding: 10px; background: white; border-radius: 5px; max-width: 400px;">
        <input type="text" id="newUsername" placeholder="Benutzername">
        <input type="password" id="newPassword" placeholder="Passwort">
        <select id="newRole">
            <option value="sales">Sales</option>
            <option value="owner">Owner</option>
        </select>
        <input type="text" id="firstName" placeholder="Vorname">
        <input type="text" id="lastName" placeholder="Nachname">
        <input type="email" id="email" placeholder="E-Mail">
        <input type="text" id="phone" placeholder="Telefonnummer (optional)">
        <button onclick="registerUser()">Benutzer anlegen</button>
        <p id="registerMessage"></p>
    </div>
    
  <div id="map"></div>
  <div class="search-container">
    <input id="searchBox" type="text" placeholder="Adresse suchen..." />
    <button onclick="searchAddress()">üîç</button>
  </div>


  <script>
      // üîê √úberpr√ºfen, ob der User eingeloggt ist
      if (!sessionStorage.getItem("userRole") || sessionStorage.getItem("userRole") !== "owner") {
          window.location.href = "index.html"; // üî• Falls kein Owner ‚Üí Zur Login-Seite
      }

      // üîê Logout-Funktion
      function logout() {
          sessionStorage.removeItem("userRole");
          window.location.href = "index.html";
      }

      const BACKEND_URL = "https://pinks.onrender.com";

      var map = L.map('map').setView([26.1224, -80.1373], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(map);

      var drawnItems = new L.FeatureGroup();
      map.addLayer(drawnItems);

      var drawControl = new L.Control.Draw({
          edit: { featureGroup: drawnItems },
          draw: { polygon: true, polyline: true, marker: true, rectangle: true, circle: false }
      });
      map.addControl(drawControl);
      
      

      var icons = {
          "ja": L.icon({ iconUrl: "icons/green.png", iconSize: [30, 30] }),
          "nein": L.icon({ iconUrl: "icons/red.png", iconSize: [30, 30] }),
          "vielleicht": L.icon({ iconUrl: "icons/yellow.png", iconSize: [30, 30] }),
          "default": L.icon({ iconUrl: "icons/default.png", iconSize: [30, 30] })
      };

      map.on(L.Draw.Event.CREATED, function (event) {
          var layer = event.layer;
          drawnItems.addLayer(layer);

          if (layer instanceof L.Marker) {
              getAddress(layer.getLatLng(), function(address) {
                  showHousePopup(layer, address);
              });
          }
      });

      function getAddress(latlng, callback) {
          fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latlng.lat}&lon=${latlng.lng}`)
              .then(response => response.json())
              .then(data => callback(data.display_name || "Unbekannte Adresse"))
              .catch(() => callback("Adresse nicht gefunden"));
      }

      function showHousePopup(layer, address) {
          let popupContent = `
              <p><strong>Adresse:</strong> ${address}</p>
              <label>Familienname:</label>
              <input type="text" id="familyName" placeholder="Nachname eingeben" />
              <p>Hat dieser Haushalt Interesse?</p>
              <button onclick="setInterest('${address}', ${layer._leaflet_id}, 'ja')">Ja</button>
              <button onclick="setInterest('${address}', ${layer._leaflet_id}, 'nein')">Nein</button>
              <button onclick="setInterest('${address}', ${layer._leaflet_id}, 'vielleicht')">Vielleicht</button>
          `;

          layer.bindPopup(popupContent).openPopup();

          setTimeout(() => {
              layer.openPopup();
          }, 100);
      }

      function setInterest(address, layerId, interest) {
          var familyName = document.getElementById("familyName") ? document.getElementById("familyName").value : "Unbekannt";
          var layer = drawnItems.getLayer(layerId) || searchMarker;

          if (!layer) {
              console.error("‚ùå Kein g√ºltiger Marker gefunden.");
              return;
          }

          layer.setIcon(icons[interest]);

          fetch(`${BACKEND_URL}/save-house`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                  lat: layer.getLatLng().lat,
                  lon: layer.getLatLng().lng,
                  interest,
                  address,
                  familyName
              })
          }).then(() => {
              console.log("‚úÖ Haus gespeichert:", address);
              loadHouses();
          }).catch(error => console.error("‚ùå Fehler beim Speichern:", error));
      }

      function loadHouses() {
          fetch(`${BACKEND_URL}/get-houses`)
              .then(response => response.json())
              .then(data => {
                  drawnItems.clearLayers();
                  data.forEach(house => {
                      var marker = L.marker([house.lat, house.lon], {
                          icon: icons[house.interest || "default"]
                      }).addTo(drawnItems)
                      .bindPopup(`
                          <p><strong>Familie ${house.family_name || "Unbekannt"}</strong></p>
                          <p>${house.full_address || "Adresse nicht gefunden"}</p>
                          <p>Interesse: ${house.interest || "Unbekannt"}</p>
                          <button onclick="deleteHouse(${house.lat}, ${house.lon})">L√∂schen</button>
                      `);
                  });

                  console.log("‚úÖ H√§user erfolgreich geladen!");
              })
              .catch(error => console.error("‚ùå Fehler beim Laden der H√§user:", error));
      }
      
      // user registrieren

      function registerUser() {
          const ownerUsername = sessionStorage.getItem("username"); // Owner-Username aus Session holen
          if (!ownerUsername) {
              alert("‚ùå Fehler: Du bist nicht eingeloggt!");
              return;
          }

          const newUsername = document.getElementById("newUsername").value.trim();
          const newPassword = document.getElementById("newPassword").value.trim();
          const newRole = document.getElementById("newRole").value;
          const firstName = document.getElementById("firstName").value.trim();
          const lastName = document.getElementById("lastName").value.trim();
          const email = document.getElementById("email").value.trim();
          const phone = document.getElementById("phone").value.trim();

          if (!newUsername || !newPassword || !newRole || !firstName || !lastName || !email) {
              document.getElementById("registerMessage").innerText = "‚ùå Alle Felder au√üer Telefon sind erforderlich.";
              return;
          }

          fetch("https://pinks.onrender.com/register", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                  ownerUsername,
                  newUsername,
                  password: newPassword,
                  role: newRole,
                  first_name: firstName,
                  last_name: lastName,
                  email,
                  phone
              })
          })
          .then(response => response.json())
          .then(data => {
              console.log("üì° Antwort vom Server:", data);
              document.getElementById("registerMessage").innerText = data.success
                  ? `‚úÖ Benutzer ${newUsername} erfolgreich angelegt.`
                  : `‚ùå Fehler: ${data.error}`;
          })
          .catch(error => {
              console.error("‚ùå Fehler bei der Registrierung:", error);
              document.getElementById("registerMessage").innerText = "‚ùå Serverfehler!";
          });
      }

      
      
    //Zeichnungen direkt speichern ohne knopf
      
      map.on(L.Draw.Event.CREATED, function (event) {
          var layer = event.layer;
          drawnItems.addLayer(layer);
          console.log("üñåÔ∏è Neue Zeichnung hinzugef√ºgt!");

          // üî• Zeichnung wird direkt nach Erstellung gespeichert
          saveDrawings();
      });

      // Zeichnungen Speichern
      function saveDrawings() {
          let geoJsonData = drawnItems.toGeoJSON();
          console.log("üì° Sende Zeichnungsdaten an Backend:", geoJsonData);

          fetch(`${BACKEND_URL}/save-drawings`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ data: geoJsonData }) // üî• Stelle sicher, dass "data" richtig gesendet wird
          })
          .then(response => response.json())
          .then(data => {
              console.log("‚úÖ Antwort vom Backend:", data);

              if (data.success) {
                  console.log("‚úÖ Zeichnungen erfolgreich gespeichert!");
              } else {
                  console.error("‚ùå Fehler beim Speichern der Zeichnungen:", data.error);
              }
          })
          .catch(error => console.error("‚ùå Netzwerkfehler beim Speichern der Zeichnungen:", error));
          
          
          
      }
//zeichnngen laden
 
        function loadDrawings() {
            fetch(`${BACKEND_URL}/get-drawings`)
            .then(response => response.json())
            .then(data => {
             console.log("üì° Zeichnungen vom Backend erhalten:", data);

             if (typeof data === "string") {
                 data = JSON.parse(data); // Falls Backend JSON als String sendet
             }

             drawnItems.clearLayers(); // üî• Entfernt alte Zeichnungen, um doppelte Eintr√§ge zu vermeiden

             let loadedDrawings = L.geoJSON(data).addTo(drawnItems);
             
             enableDrawingDeletion(); // üî• Klickbares L√∂schen aktivieren

             console.log("‚úÖ Zeichnungen erfolgreich geladen!");
         })
         .catch(error => console.error("‚ùå Fehler beim Laden der Zeichnungen:", error));
 }


      // üî• Aktiviert Klick-Event f√ºr das L√∂schen von Zeichnungen
      function enableDrawingDeletion() {
          drawnItems.eachLayer(layer => {
              layer.on('click', function () {
                  if (confirm("M√∂chtest du diese Zeichnung wirklich l√∂schen?")) {
                      deleteDrawings(layer); // üî• Zeichnung aus DB entfernen
                  }
              });
          });
      }

      // üî• Zeichnung l√∂schen und in der Datenbank aktualisieren
      function deleteDrawings(layer) {
          drawnItems.removeLayer(layer); // Entfernt das Layer von der Karte

          let geoJsonData = drawnItems.toGeoJSON(); // Holt alle restlichen Zeichnungen
          console.log("üì° Zeichnung wird gel√∂scht, aktualisiere Datenbank:", geoJsonData);

          fetch(`${BACKEND_URL}/save-drawings`, { // üî• Speichert nur die verbleibenden Zeichnungen
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ data: geoJsonData }) // Aktualisiert die Datenbank mit den restlichen Zeichnungen
          })
          .then(response => response.json())
          .then(data => {
              if (data.success) {
                  console.log("‚úÖ Zeichnung erfolgreich gel√∂scht!");
              } else {
                  console.error("‚ùå Fehler beim L√∂schen der Zeichnung:", data.error);
              }
          })
          .catch(error => console.error("‚ùå Netzwerkfehler beim L√∂schen der Zeichnung:", error));
      }


      let searchMarker = null;
      function searchAddress() {
          let query = document.getElementById("searchBox").value.trim();
          if (query === "") {
              alert("‚ùå Bitte eine Adresse eingeben!");
              return;
          }

          fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}`)
              .then(response => response.json())
              .then(data => {
                  console.log("üì° API Antwort:", data);

                  if (data.length === 0) {
                      alert("‚ùå Adresse nicht gefunden!");
                      return;
                  }

                  let latlng = {
                      lat: parseFloat(data[0].lat),
                      lng: parseFloat(data[0].lon)
                  };

                  if (searchMarker) {
                      map.removeLayer(searchMarker);
                  }

                  searchMarker = L.marker(latlng, { icon: icons["default"] }).addTo(map);
                  map.setView(latlng, 16);

                  getAddress(latlng, function(address) {
                      showHousePopup(searchMarker, address);
                  });
              })
              .catch(error => console.error("‚ùå Fehler bei der Adresssuche:", error));
      }

      document.getElementById("searchBox").addEventListener("change", function () {
          searchAddress();
      });
      
      function deleteHouse(lat, lon) {
          console.log(`üì° Sende L√∂schanfrage f√ºr: lat=${lat}, lon=${lon}`);

          fetch(`${BACKEND_URL}/delete-house`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ lat, lon })
          })
          .then(response => response.json())
          .then(data => {
              if (data.success) {
                  console.log(`‚úÖ Haus erfolgreich gel√∂scht: lat=${lat}, lon=${lon}`);

                  // üî• Entferne den Marker aus `drawnItems`
                  drawnItems.eachLayer(layer => {
                      if (layer instanceof L.Marker) {
                          let markerLatLng = layer.getLatLng();
                          if (markerLatLng.lat === lat && markerLatLng.lng === lon) {
                              drawnItems.removeLayer(layer);
                              console.log("üóëÔ∏è Marker von der Karte entfernt!");
                          }
                      }
                  });

                  // üîÑ Aktualisiere die Liste der H√§user
                  loadHouses();
              } else {
                  console.error("‚ùå Fehler beim L√∂schen des Hauses:", data.error);
              }
          })
          .catch(error => console.error("‚ùå Netzwerkfehler beim L√∂schen des Hauses:", error));
      }


      loadHouses();
      loadDrawings();

  </script>
</body>
</html>









